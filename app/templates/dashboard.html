{% extends "base.html" %}
{% block content %}
<div style="margin-bottom: 2rem;">
    <h1 style="margin-bottom: 0.5rem;">Dashboard</h1>
    <p style="color: var(--pico-muted-color); margin-top: 0;">Ol√°, <strong>{{ current_user.username }}</strong>! Bem-vindo √† sua p√°gina protegida.</p>
</div>

<!-- Estat√≠sticas R√°pidas -->
<div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 1rem; margin-bottom: 2rem;">
    <div style="background: var(--pico-card-background-color); padding: 1.5rem; border-radius: 8px; border: 1px solid var(--pico-card-border-color);">
        <div style="color: var(--pico-muted-color); font-size: 0.875rem; margin-bottom: 0.5rem;">Total de Formul√°rios</div>
        <div style="font-size: 2rem; font-weight: bold; color: var(--pico-color-blue-500);">{{ total_formularios }}</div>
    </div>
    
    <div style="background: var(--pico-card-background-color); padding: 1.5rem; border-radius: 8px; border: 1px solid var(--pico-card-border-color);">
        <div style="color: var(--pico-muted-color); font-size: 0.875rem; margin-bottom: 0.5rem;">Total de Respostas</div>
        <div style="font-size: 2rem; font-weight: bold; color: var(--pico-color-green-500);">{{ total_estudantes }}</div>
    </div>
</div>

<!-- Gr√°fico de Cursos Populares -->
{% if grafico_labels and grafico_values %}
<div style="background: var(--pico-card-background-color); padding: 1.5rem; border-radius: 8px; border: 1px solid var(--pico-card-border-color); margin-bottom: 2rem;">
    <h3 style="margin-top: 0;">Cursos Mais Populares</h3>
    <canvas id="cursosChart" style="max-height: 300px;"></canvas>
</div>
{% endif %}

<!-- √öltimos Formul√°rios -->
{% if ultimos_formularios %}
<div style="background: var(--pico-card-background-color); padding: 1.5rem; border-radius: 8px; border: 1px solid var(--pico-card-border-color); margin-bottom: 2rem;">
    <h3 style="margin-top: 0;">√öltimos Formul√°rios Cadastrados</h3>
    <table role="grid">
        <thead>
            <tr>
                <th>Nome do Formul√°rio</th>
                <th>Data de Cadastro</th>
                <th>A√ß√µes</th>
            </tr>
        </thead>
        <tbody>
            {% for formulario in ultimos_formularios %}
            <tr>
                <td>{{ formulario.nome_amigavel }}</td>
                <td>{{ formulario.data_cadastro.strftime('%d/%m/%Y %H:%M') }}</td>
                <td>
                    <a href="{{ url_for('main.view_sheet_data', planilha_id=formulario.id) }}" style="margin-right: 0.5rem; font-size: 0.875rem;">Ver</a>
                    <a href="{{ url_for('main.process_sheet', planilha_id=formulario.id) }}" style="font-size: 0.875rem;">Processar</a>
                </td>
            </tr>
            {% endfor %}
        </tbody>
    </table>
</div>
{% endif %}

<!-- Menu Principal -->
<div class="dashboard-grid" style="display: grid; grid-template-columns: repeat(auto-fit, minmax(250px, 1fr)); gap: 1rem; margin-bottom: 2rem;">
    <a href="{{ url_for('main.manage_sheets') }}" style="background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); color: white; padding: 2rem; border-radius: 8px; text-decoration: none; text-align: center; transition: transform 0.2s;" onmouseover="this.style.transform='translateY(-4px)'" onmouseout="this.style.transform='translateY(0)'">
        <div style="font-size: 2rem; margin-bottom: 0.5rem;">üìä</div>
        <div style="font-weight: bold; font-size: 1.125rem;">Gerenciar Fontes de Dados</div>
    </a>
    
    <a href="{{ url_for('main.view_processed_data') }}" style="background: linear-gradient(135deg, #f093fb 0%, #f5576c 100%); color: white; padding: 2rem; border-radius: 8px; text-decoration: none; text-align: center; transition: transform 0.2s;" onmouseover="this.style.transform='translateY(-4px)'" onmouseout="this.style.transform='translateY(0)'">
        <div style="font-size: 2rem; margin-bottom: 0.5rem;">üëÅÔ∏è</div>
        <div style="font-weight: bold; font-size: 1.125rem;">Visualizar Dados</div>
    </a>
    
    <a href="{{ url_for('main.analysis') }}" style="background: linear-gradient(135deg, #4facfe 0%, #00f2fe 100%); color: white; padding: 2rem; border-radius: 8px; text-decoration: none; text-align: center; transition: transform 0.2s;" onmouseover="this.style.transform='translateY(-4px)'" onmouseout="this.style.transform='translateY(0)'">
        <div style="font-size: 2rem; margin-bottom: 0.5rem;">üìà</div>
        <div style="font-weight: bold; font-size: 1.125rem;">An√°lise Descritiva</div>
    </a>
    
    <a href="{{ url_for('main.ml_analysis') }}" style="background: linear-gradient(135deg, #43e97b 0%, #38f9d7 100%); color: white; padding: 2rem; border-radius: 8px; text-decoration: none; text-align: center; transition: transform 0.2s;" onmouseover="this.style.transform='translateY(-4px)'" onmouseout="this.style.transform='translateY(0)'">
        <div style="font-size: 2rem; margin-bottom: 0.5rem;">ü§ñ</div>
        <div style="font-weight: bold; font-size: 1.125rem;">An√°lise com ML</div>
    </a>
</div>

<!-- Status da Conex√£o Google -->
<footer style="border-top: 1px solid var(--pico-card-border-color); padding-top: 1.5rem; margin-top: 2rem;">
    {% if not current_user.google_credentials %}
        <div style="background: var(--pico-card-background-color); padding: 1rem; border-radius: 8px; border-left: 4px solid var(--pico-color-amber-500);">
            <p style="margin: 0 0 1rem 0;">‚ö†Ô∏è Para interagir com o Google, voc√™ precisa conectar sua conta.</p>
            <a href="{{ url_for('main.authorize_google') }}" role="button">Conectar com o Google</a>
        </div>
    {% else %}
        <div style="display: flex; justify-content: space-between; align-items: center; flex-wrap: wrap; gap: 1rem; background: var(--pico-card-background-color); padding: 1rem; border-radius: 8px; border-left: 4px solid var(--pico-color-green-500);">
            <p style="color: var(--pico-color-green-500); margin: 0;">
                ‚úÖ Conectado como: <strong>{{ current_user.email }}</strong>
            </p>
            <a href="{{ url_for('main.disconnect_google') }}" role="button" class="outline">Desconectar</a>
        </div>
    {% endif %}
</footer>

<!-- Script para o gr√°fico -->
{% if grafico_labels and grafico_values %}
<script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.0/dist/chart.umd.min.js"></script>
<script>
    const ctx = document.getElementById('cursosChart');
    
    // --- CORRE√á√ÉO APLICADA AQUI ---
    // Adicionado o filtro | safe para garantir que o JSON seja renderizado corretamente como JavaScript
    const labels = {{ grafico_labels | tojson | safe }};
    const values = {{ grafico_values | tojson | safe }};
    
    // Verifica√ß√£o adicional no cliente
    if (Array.isArray(labels) && Array.isArray(values) && labels.length > 0 && values.length > 0) {
        new Chart(ctx, {
            type: 'bar',
            data: {
                labels: labels,
                datasets: [{
                    label: 'N√∫mero de Estudantes',
                    data: values,
                    backgroundColor: [
                        'rgba(102, 126, 234, 0.8)',
                        'rgba(118, 75, 162, 0.8)',
                        'rgba(240, 147, 251, 0.8)',
                        'rgba(245, 87, 108, 0.8)',
                        'rgba(79, 172, 254, 0.8)'
                    ],
                    borderColor: [
                        'rgba(102, 126, 234, 1)',
                        'rgba(118, 75, 162, 1)',
                        'rgba(240, 147, 251, 1)',
                        'rgba(245, 87, 108, 1)',
                        'rgba(79, 172, 254, 1)'
                    ],
                    borderWidth: 2
                }]
            },
            options: {
                responsive: true,
                maintainAspectRatio: true,
                plugins: {
                    legend: {
                        display: false
                    }
                },
                scales: {
                    y: {
                        beginAtZero: true,
                        ticks: {
                            stepSize: 1
                        }
                    }
                }
            }
        });
    }
</script>
{% endif %}

{% endblock %}

